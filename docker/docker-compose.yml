# services:
#   mongo:
#     image: mongo:latest
#     container_name: mongodb
#     ports: ["27017:27017"]
#     volumes: ["mongo_data:/data/db"]

#   server:
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.server
#     container_name: backend_server
#     ports: ["5000:5000"]
#     depends_on: ["mongo"]

#   client:
#     build:
#       context: ..
#       dockerfile: docker/Dockerfile.client
#     container_name: frontend_client
#     ports: ["80:80"]
#     depends_on: ["server"]

# volumes:
#   mongo_data:

services:
  # ============================================
  # MongoDB Database
  # ============================================
  mongo:
    image: mongo:7
    container_name: mern-mongo
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=mernapp
    networks:
      - mern-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ============================================
  # Backend Server (Node.js/Express)
  # ============================================
  server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.server
    container_name: mern-server
    restart: unless-stopped
    env_file:
      - ../server/.env
    environment:
      - NODE_ENV=development
      - PORT=5000
      - MONGO_URI=mongodb://mongo:27017/mernapp
    ports:
      - "5000:5000"
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - mern-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # ============================================
  # Frontend Client (React + Nginx)
  # ============================================
  client:
    build:
      context: ..
      dockerfile: docker/Dockerfile.client
    container_name: mern-client
    restart: unless-stopped
    ports:
      - "3000:80"
    depends_on:
      server:
        condition: service_healthy
    networks:
      - mern-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# ============================================
# Networks
# ============================================
networks:
  mern-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  mongo_data:
    driver: local